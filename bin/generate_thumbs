#!/bin/bash

REPO_ROOT=$(pwd)
IMAGES_DIR="$REPO_ROOT/src/images"
OUTPUT_FILE="$REPO_ROOT/src/_data/image_thumbnails.json"
TEMP_DIR="/tmp/thumbs_$$"  # Use process ID to avoid conflicts

# Create temp directory and output directory
mkdir -p "$TEMP_DIR"
mkdir -p "$(dirname "$OUTPUT_FILE")"

# Ensure temp directory is removed on exit
trap 'rm -rf "$TEMP_DIR"' EXIT

# Function to extract dimensions from JPEG header
extract_jpeg_dimensions() {
  local file="$1"
  # Use 'file' command to get image dimensions
  # Example output: "JPEG image data, JFIF standard 1.01, resolution (DPI), density 72x72, segment length 16, baseline, precision 8, 1920x1080, components 3"
  local info=$(file "$file")
  
  # Extract dimensions using regex
  if [[ $info =~ ([0-9]+)x([0-9]+) ]]; then
    echo "${BASH_REMATCH[1]}/${BASH_REMATCH[2]}"
  else
    # Default if we can't extract dimensions
    echo "1/1"
  fi
}

# Start JSON file
echo "{" > $OUTPUT_FILE

# Counter for handling trailing commas
count=0
total=$(find $IMAGES_DIR -name "*.jpg" | wc -l)

for img in $IMAGES_DIR/*.jpg; do
  filename=$(basename "$img")
  count=$((count+1))
  
  # Get image dimensions
  dimensions=$(extract_jpeg_dimensions "$img")
  
  # Create WebP thumbnail using cwebp
  temp_webp="$TEMP_DIR/${filename%.*}.webp"
  
  # Use cwebp with aggressive settings:
  # - Tiny size (8x8)
  # - Low quality (10)
  # - Use strong filter
  # - Use sharp YUV
  # - Quiet mode to suppress output
  cwebp -quiet -resize 16 0 -q 10 -f 60 -strong -sharp_yuv "$img" -o "$temp_webp"
  
  # Convert to base64
  base64_img=$(base64 -w 0 "$temp_webp")
  
  # Add to JSON
  echo "  \"$filename\": {" >> $OUTPUT_FILE
  echo "    \"base64\": \"data:image/webp;base64,$base64_img\"," >> $OUTPUT_FILE
  echo "    \"aspect_ratio\": \"$dimensions\"" >> $OUTPUT_FILE
  
  # Add comma if not the last item
  if [ $count -lt $total ]; then
    echo "  }," >> $OUTPUT_FILE
  else
    echo "  }" >> $OUTPUT_FILE
  fi
  
  echo "Processed: $filename"
done

# Close JSON file
echo "}" >> $OUTPUT_FILE

echo "Processing complete: Generated $count thumbnails"
echo "Output saved to: $OUTPUT_FILE"
