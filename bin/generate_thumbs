#!/bin/bash

REPO_ROOT=$(pwd)
IMAGES_DIR="$REPO_ROOT/src/images"
OUTPUT_FILE="$REPO_ROOT/src/_data/image_thumbnails.json"

echo "{" > $OUTPUT_FILE

count=0
total=$(find $IMAGES_DIR -name "*.jpg" | wc -l)

for img in $IMAGES_DIR/*.jpg; do
  filename=$(basename "$img")
  count=$((count+1))
  
  dimensions=$(identify -format "%w/%h" "$img")
  
  # Create a tiny thumbnail with aggressive optimization
  # 1. Small size (10x10 pixels)
  # 2. Very low quality (10)
  # 3. Apply stronger blur
  # 4. Use WebP format for better compression
  # 5. Strip all metadata
  # 6. Dither to reduce colors
  base64_img=$(magick "$img" -resize 16x16 -blur 0x1 -quality 10 -strip -dither FloydSteinberg -colors 8 webp:- | base64 -w 0)
  
  # Add to JSON
  echo "  \"$filename\": {" >> $OUTPUT_FILE
  echo "    \"base64\": \"data:image/webp;base64,$base64_img\"," >> $OUTPUT_FILE
  echo "    \"aspect_ratio\": \"$dimensions\"" >> $OUTPUT_FILE
  
  # Add comma if not the last item
  if [ $count -lt $total ]; then
    echo "  }," >> $OUTPUT_FILE
  else
    echo "  }" >> $OUTPUT_FILE
  fi
  
  echo "Processed: $filename"
done

echo "}" >> $OUTPUT_FILE

echo "Processing complete: Generated $count thumbnails"
echo "Output saved to: $OUTPUT_FILE"
